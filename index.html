<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Earn & Reward App</title>
    
    <!-- Google Fonts (Nunito) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

    <!-- Internal CSS -->
    <style>
        /* Google Font Import */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap');

        /* CSS Variables for Theming */
        :root {
            --font-family: 'Nunito', sans-serif;
            --bg-color-light: #f7f8fa;
            --secondary-bg-light: rgba(255, 255, 255, 0.1);
            --text-color-light: #1c1c1e;
            --subtle-text-light: #6d6d72;
            --primary-color-light: #007aff;
            --border-color-light: rgba(255, 255, 255, 0.2);
            --bg-color-dark: #121212;
            --secondary-bg-dark: rgba(0, 0, 0, 0.1);
            --text-color-dark: #ffffff;
            --subtle-text-dark: #8e8e93;
            --primary-color-dark: #0a84ff;
            --border-color-dark: rgba(255, 255, 255, 0.2);
            --glass-blur: blur(10px);
            --glass-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            --glow-color: rgba(0, 122, 255, 0.5);
        }

        /* Base Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            transition: background-color 0.3s, color 0.3s;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(270deg, #007aff, #6a1b9a, #009688, #303f9f);
            background-size: 800% 800%;
            animation: gradientAnimation 15s ease infinite;
        }
        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Theme Styles */
        body.light-theme { background-color: var(--bg-color-light); color: var(--text-color-light); }
        body.dark-theme { background-color: var(--bg-color-dark); color: var(--text-color-dark); }
        #app { max-width: 500px; margin: 0 auto; padding-bottom: 70px; }

        /* Glassmorphism Effect */
        .glass-card {
            background: var(--secondary-bg-light);
            backdrop-filter: var(--glass-blur);
            border-radius: 12px;
            border: 1px solid var(--border-color-light);
            box-shadow: var(--glass-shadow);
            transition: box-shadow 0.3s;
            padding: 15px;
        }
        .glass-card:hover { box-shadow: 0 8px 40px var(--glow-color); }
        .dark-theme .glass-card {
            background: var(--secondary-bg-dark);
            border: 1px solid var(--border-color-dark);
        }

        /* Profile Header */
        .profile-header { padding: 20px 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid; }
        .light-theme .profile-header { border-bottom-color: var(--border-color-light); }
        .dark-theme .profile-header { border-bottom-color: var(--border-color-dark); }
        .profile-info { display: flex; align-items: center; gap: 15px; }
        #user-photo { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid; box-shadow: 0 0 15px var(--glow-color); animation: glowRing 2s ease-in-out infinite; }
        @keyframes glowRing { 0%, 100% { box-shadow: 0 0 10px var(--glow-color); } 50% { box-shadow: 0 0 20px var(--glow-color); } }
        .light-theme #user-photo { border-color: var(--primary-color-light); }
        .dark-theme #user-photo { border-color: var(--primary-color-dark); }
        .user-details h1 { font-size: 1.2rem; font-weight: 700; }
        .verified-icon { font-size: 1rem; margin-left: 5px; }
        .light-theme .verified-icon { color: var(--primary-color-light); }
        .dark-theme .verified-icon { color: var(--primary-color-dark); }
        .user-details p { font-size: 0.9rem; font-weight: 600; }
        .light-theme .user-details p { color: var(--subtle-text-light); }
        .dark-theme .user-details p { color: var(--subtle-text-dark); }

        /* Dark Mode Toggle */
        .toggle-container { display: flex; align-items: center; }
        .toggle-label { font-size: 0.8rem; margin-right: 10px; }
        .toggle-switch { position: relative; width: 50px; height: 25px; background: var(--secondary-bg-light); border-radius: 25px; cursor: pointer; transition: background 0.3s; backdrop-filter: var(--glass-blur); box-shadow: var(--glass-shadow); }
        .toggle-switch::before { content: ''; position: absolute; top: 2px; left: 2px; width: 21px; height: 21px; background: var(--primary-color-light); border-radius: 50%; transition: transform 0.3s; }
        input[type="checkbox"]:checked + .toggle-switch { background: var(--primary-color-light); }
        input[type="checkbox"]:checked + .toggle-switch::before { transform: translateX(25px); background: #fff; }
        .dark-theme .toggle-switch::before { background: var(--primary-color-dark); }
        .dark-theme input[type="checkbox"]:checked + .toggle-switch { background: var(--primary-color-dark); }

        /* Main Content & Pages */
        main { padding: 15px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h2 { font-size: 1.5rem; margin-bottom: 15px; }

        /* Date Time Box */
        .date-time-box { display: flex; justify-content: space-between; margin-bottom: 20px; padding: 10px; border-radius: 8px; }
        #date-display { font-size: 1rem; }
        #time-display { font-size: 1rem; }

        /* Task/Bonus Container */
        .task-container { padding: 20px; text-align: center; margin-bottom: 20px; }
        .task-container:last-child { margin-bottom: 0; }
        .task-icon { font-size: 3rem; margin-bottom: 15px; animation: glowIcon 2s ease infinite; }
        @keyframes glowIcon { 0%, 100% { text-shadow: 0 0 5px var(--glow-color); } 50% { text-shadow: 0 0 15px var(--glow-color); } }
        .light-theme .task-icon { color: var(--primary-color-light); }
        .dark-theme .task-icon { color: var(--primary-color-dark); }
        .task-container h3 { font-size: 1.2rem; margin-bottom: 5px; }
        .task-container p { font-size: 0.9rem; margin-bottom: 20px; }
        .light-theme .task-container p { color: var(--subtle-text-light); }
        .dark-theme .task-container p { color: var(--subtle-text-dark); }

        /* Action Button */
        .action-btn { width: 100%; padding: 15px; font-size: 1rem; font-weight: 700; color: #fff; border: none; border-radius: 10px; cursor: pointer; transition: background-color 0.2s, opacity 0.2s, box-shadow 0.3s; position: relative; display: flex; justify-content: center; align-items: center; background: linear-gradient(45deg, var(--primary-color-light), #6a1b9a); }
        .light-theme .action-btn { background-color: var(--primary-color-light); }
        .dark-theme .action-btn { background-color: var(--primary-color-dark); }
        .action-btn:hover { box-shadow: 0 0 20px var(--glow-color); }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-loader { width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.4); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; display: none; }
        .action-btn.loading .btn-text { visibility: hidden; }
        .action-btn.loading .btn-loader { display: block; position: absolute; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Form Styles */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, select { width: 100%; padding: 12px; border-radius: 8px; font-family: var(--font-family); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; background: var(--secondary-bg-light); backdrop-filter: var(--glass-blur); border: 1px solid var(--border-color-light); }
        .light-theme input, .light-theme select { color: var(--text-color-light); }
        .dark-theme input, .dark-theme select { background: var(--secondary-bg-dark); border: 1px solid var(--border-color-dark); color: var(--text-color-dark); }
        input:focus, select:focus { border-color: var(--glow-color); box-shadow: 0 0 15px var(--glow-color); }

        /* Streak Progress */
        .streak-progress { margin-bottom: 20px; }
        .progress-bar { height: 10px; background: var(--border-color-light); border-radius: 5px; }
        .progress-fill { height: 100%; background: var(--primary-color-light); width: 0%; transition: width 0.5s; }

        /* Countdown Timer */
        .countdown-timer { text-align: center; margin-bottom: 20px; }
        #timer { font-size: 1.5rem; }

        /* Coin History */
        .coin-history { margin-top: 20px; }
        .history-item { padding: 10px; border-bottom: 1px solid var(--border-color-light); }

        /* Referral Animation */
        .gift-box { animation: shake 1s infinite; font-size: 2rem; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Sharing Options */
        .sharing-options { display: flex; justify-content: space-around; margin-top: 20px; }
        .share-btn { font-size: 1.5rem; cursor: pointer; }

        /* QR Code */
        #qr-code { margin-top: 10px; display: none; }

        /* Anti-Fraud */
        .anti-fraud { font-size: 0.8rem; color: red; margin-top: 10px; }

        /* Withdraw Status */
        .withdraw-status { margin-bottom: 20px; }
        .status-item { padding: 10px; border-radius: 8px; margin-bottom: 10px; }

        /* Security Tips */
        .security-tips { margin-top: 20px; font-size: 0.9rem; }

        /* Withdrawal Limit */
        .withdraw-limit { margin-top: 10px; }

        /* History Filters */
        .history-filters { margin-top: 20px; }
        .filter-btn { padding: 5px 10px; margin-right: 5px; border-radius: 5px; }

        /* Membership Badge */
        .membership-badge { font-size: 1rem; margin-left: 10px; padding: 5px 10px; border-radius: 20px; }
        .free { background: green; }
        .verified { background: gold; }
        .premium { background: blue; }
        .diamond { background: purple; }

        /* Help Support */
        .help-support { margin-top: 20px; }

        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; display: flex; justify-content: space-around; padding: 5px 0; border-top: 1px solid; z-index: 1000; backdrop-filter: var(--glass-blur); }
        .light-theme .bottom-nav { background: var(--secondary-bg-light); border-top-color: var(--border-color-light); }
        .dark-theme .bottom-nav { background: var(--secondary-bg-dark); border-top-color: var(--border-color-dark); }
        .nav-btn { background: none; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; padding: 5px 10px; font-family: var(--font-family); font-size: 0.7rem; transition: color 0.2s, transform 0.2s; flex-grow: 1; }
        .light-theme .nav-btn { color: var(--subtle-text-light); }
        .dark-theme .nav-btn { color: var(--subtle-text-dark); }
        .nav-btn i { font-size: 1.4rem; margin-bottom: 3px; transition: text-shadow 0.3s; }
        .nav-btn.active { font-weight: 700; }
        .light-theme .nav-btn.active { color: var(--primary-color-light); }
        .dark-theme .nav-btn.active { color: var(--primary-color-dark); }
        .nav-btn.active i { text-shadow: 0 0 10px var(--glow-color); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center; backdrop-filter: var(--glass-blur); }
        .modal-content { padding: 30px; border-radius: 15px; text-align: center; background: var(--secondary-bg-light); backdrop-filter: var(--glass-blur); border: 1px solid var(--border-color-light); box-shadow: var(--glass-shadow); }
        .dark-theme .modal-content { background: var(--secondary-bg-dark); border: 1px solid var(--border-color-dark); }
        .loader { border: 5px solid #f3f3f3; border-radius: 50%; border-top: 5px solid; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        .light-theme .loader { border-top-color: var(--primary-color-light); }
        .dark-theme .loader { border-top-color: var(--primary-color-dark); }

        /* Success Animation */
        .success-modal { font-size: 2rem; animation: bounce 1s; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-30px); } 60% { transform: translateY(-15px); } }

        /* Coin Bounce */
        #user-points { animation: bounce 0.5s when changed; }
    </style>
</head>
<body>

    <div id="app">
        <header class="profile-header">
            <div class="profile-info">
                <img id="user-photo" src="" alt="User Photo">
                <div class="user-details">
                    <h1 id="user-name">Loading... <i class="fas fa-check-circle verified-icon"></i></h1>
                    <p> Balance: ৳<span id="user-points">0</span>TK</p>
                </div>
            </div>
            <div class="toggle-container">
                <label class="toggle-label">Dark Mode</label>
                <input type="checkbox" id="dark-mode-toggle" style="display: none;">
                <label for="dark-mode-toggle" class="toggle-switch"></label>
            </div>
        </header>

        <main id="main-content">
            <!-- Home Page -->
            <div id="home-page" class="page active glass-card">
                <h2>Dashboard</h2>
                <div class="date-time-box glass-card">
                    <span id="date-display"></span>
                    <span id="time-display"></span>
                </div>
                <div class="task-container glass-card">
                    <i class="fas fa-video task-icon"></i>
                    <h3>Watch Ad & Earn</h3>
                    <p>Earn 0.25 TK (15 sec wait required)</p>
                    <button id="watch-ad-btn" class="action-btn">Watch Ad</button>
                </div>
                <div class="task-container glass-card">
                    <i class="fas fa-camera task-icon"></i>
                    <h3>Watch Product Review Ad</h3>
                    <p>Earn 0.25 TK (15 sec wait required)</p>
                    <button id="product-review-btn" class="action-btn">Watch Review</button>
                </div>
                <div class="task-container glass-card">
                    <i class="fas fa-film task-icon"></i>
                    <h3>Watch 3 Ads in a Row</h3>
                    <p>Earn 0.75 TK Bonus (15 sec wait per ad)</p>
                    <button id="watch-three-btn" class="action-btn">Start Watching</button>
                </div>
            </div>

            <!-- Tasks Page -->
            <div id="tasks-page" class="page glass-card">
                <h2>Complete Tasks</h2>
                <div class="streak-progress glass-card">
                    <h3>Streak Progress</h3>
                    <div class="progress-bar"><div class="progress-fill" id="streak-fill"></div></div>
                </div>
                <div class="countdown-timer glass-card">
                    <h3>Next Bonus in</h3>
                    <span id="timer">60:00</span>
                    <button id="claim-bonus-btn" class="action-btn" disabled>Claim Bonus</button>
                </div>
                <!-- 10+ Tasks (examples) -->
                <div class="task-container glass-card">
                    <i class="fas fa-video task-icon"></i>
                    <h3>Watch Ad & Earn</h3>
                    <p>Earn 0.25 TK (15 sec wait)</p>
                    <button class="action-btn watch-ad-task">Watch</button>
                </div>
                <div class="task-container glass-card">
                    <i class="fas fa-camera task-icon"></i>
                    <h3>Watch Product Review Ad</h3>
                    <p>Earn 0.25 TK (15 sec wait)</p>
                    <button class="action-btn product-review-task">Watch</button>
                </div>
                <div class="task-container glass-card">
                    <i class="fas fa-film task-icon"></i>
                    <h3>Watch 3 Ads in a Row</h3>
                    <p>30 TK Bonus (30 sec wait)</p>
                    <button class="action-btn watch-three-task">Start</button>
                </div>
                <!-- Additional tasks -->
                <div class="task-container glass-card">
                    <i class="fas fa-check task-icon"></i>
                    <h3>Daily Check-in</h3>
                    <p>Earn 1 TK</p>
                    <button class="action-btn daily-checkin">Check-in</button>
                </div>
                <div class="task-container glass-card">
                    <i class="fas fa-share task-icon"></i>
                    <h3>Share App</h3>
                    <p>Earn 2 TK</p>
                    <button class="action-btn share-app">Share</button>
                </div>
                <div class="task-container glass-card">
                    <i class="fas fa-star task-icon"></i>
                    <h3>Rate App</h3>
                    <p>Earn 5 TK</p>
                    <button class="action-btn rate-app">Rate</button>
                </div>
                <div class="task-container glass-card">
                    <i class="fas fa-puzzle-piece task-icon"></i>
                    <h3>Complete Survey</h3>
                    <p>Earn 3 TK</p>
                    <button class="action-btn complete-survey">Start Survey</button>
                </div>
                <div class="task-container glass-card">
                    <i class="fas fa-gamepad task-icon"></i>
                    <h3>Play Mini Game</h3>
                    <p>Earn 4 TK</p>
                    <button class="action-btn play-game">Play</button>
                </div>
                <div class="task-container glass-card">
                    <i class="fas fa-book task-icon"></i>
                    <h3>Read Article</h3>
                    <p>Earn 2 TK</p>
                    <button class="action-btn read-article">Read</button>
                </div>
                <div class="task-container glass-card">
                    <i class="fas fa-video task-icon"></i>
                    <h3>Watch Tutorial</h3>
                    <p>Earn 1 TK</p>
                    <button class="action-btn watch-tutorial">Watch</button>
                </div>
                <div class="coin-history glass-card">
                    <h3>Coin History</h3>
                    <div id="history-list"></div>
                </div>
            </div>

            <!-- Refer Page -->
            <div id="refer-page" class="page glass-card">
                <h2>Refer & Earn</h2>
                <div class="referral-section glass-card">
                    <h3>Refer & Earn More!</h3>
                    <p class="gift-box">🎁</p>
                    <p>Share your link to get bonus points.</p>
                    <input type="text" id="referral-link" readonly>
                    <div class="sharing-options">
                        <i class="fas fa-copy share-btn" id="copy-ref"></i>
                        <i class="fas fa-qrcode share-btn" id="qr-btn"></i>
                    </div>
                    <canvas id="qr-code"></canvas>
                    <div class="anti-fraud">Fake or duplicate referrals may result in reward removal.</div>
                </div>
                <div class="bonus-breakdown glass-card">
                    <h3>Referral Bonus Breakdown</h3>
                    <p>✅ You will earn: 10 TK</p>
                    <p>👥 Your friend will get: 5 TK</p>
                </div>
            </div>

            <!-- Withdraw Page -->
            <div id="withdraw-page" class="page glass-card">
                <h2>Withdraw</h2>
                <p>Minimum 50 TK required to withdraw.</p>
                <div class="withdraw-status glass-card">
                    <h3>Withdrawal Status</h3>
                    <div id="status-list"></div>
                </div>
                <form id="withdraw-form">
                    <div class="form-group">
                        <label for="withdraw-method">Method:</label>
                        <select id="withdraw-method" required>
                            <option value="Bkash">🟦 Bkash</option>
                            <option value="Nagad">🟩 Nagad</option>
                            <option value="Mobile Recharge">🟨 Mobile Recharge</option>
                            <option value="Binance">Binance</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="account-number">Account Number/ID:</label>
                        <input type="text" id="account-number" placeholder="e.g., 012345..." required>
                    </div>
                    <div class="form-group">
                        <label for="amount">Taka to Withdraw:</label>
                        <input type="number" id="amount" placeholder="e.g., 02" required>
                    </div>
                    <button type="submit" id="withdraw-submit-btn" class="action-btn">
                        <span class="btn-text">Submit Request</span>
                        <span class="btn-loader"></span>
                    </button>
                </form>
                <div class="security-tips glass-card">
                    <p>🔒 আপনার একাউন্ট নিরাপদ রাখতে সঠিক নাম্বার ব্যবহার করুন। ভুল নাম্বারে টাকা ফেরত পাওয়া যাবে না।</p>
                    <p>🔒 উইথড্র পেন্ডিং থাকা অবস্থায় উইথড্র দিতে পারবেন না তাহলে টাকা পাবেন না</p>
                </div>
                <div class="withdraw-limit glass-card">
                    <p>📅 Next eligible withdrawal: In 2 days</p>
                    <p>🔁 You can withdraw every days</p>
                </div>
                <div class="history-filters glass-card">
                    <h3>Transaction History</h3>
                    <button class="filter-btn action-btn">Approved</button>
                    <button class="filter-btn action-btn">Rejected</button>
                    <button class="filter-btn action-btn">Pending</button>
                    <input type="text" placeholder="Search by date, amount, method">
                    <div id="history-list-withdraw"></div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile-page" class="page glass-card">
                <h2>Profile</h2>
                <div class="user-stats glass-card">
                    <p>Total Earnings: <span id="total-earnings">0 TK</span></p>
                    <p>Total Referrals: <span id="total-referrals">0</span></p>
                    <p>Tasks Completed: <span id="tasks-completed">0</span></p>
                </div>
                <div class="membership-badge free">🟢 Free Member</div>
                <div class="help-support glass-card">
                    <button class="action-btn"><i class="fas fa-question-circle"></i> Need Help? Contact Us</button>
                </div>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-btn active" data-page="home-page"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-btn" data-page="tasks-page"><i class="fas fa-tasks"></i><span>Tasks</span></button>
            <button class="nav-btn" data-page="refer-page"><i class="fas fa-user-friends"></i><span>Refer</span></button>
            <button class="nav-btn" data-page="withdraw-page"><i class="fas fa-wallet"></i><span>Withdraw</span></button>
            <button class="nav-btn" data-page="profile-page"><i class="fas fa-user"></i><span>Profile</span></button>
        </nav>
    </div>

    <div id="loading-modal" class="modal">
        <div class="modal-content"><div class="loader"></div><p>Loading Ad...</p></div>
    </div>
    
    <div id="timer-modal" class="modal">
        <div class="modal-content"><p>Wait 15 seconds...</p><span id="ad-timer">15</span></div>
    </div>
    
    <div id="success-modal" class="modal">
        <div class="modal-content success-modal">🎉 Request Processed!</div>
    </div>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='9712189' data-sdk=''></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;

            // Configuration
            const BOT_TOKEN = "7962156961:AAHZ5oI8JPLA3eVQVemgtif6MsZy7sD7QMQ";
            const BOT_USERNAME = "democash00_bot";
            const ADMIN_CHAT_ID = "6453637469";
            const DAILY_AD_LIMIT = 300;
            const POINTS_PER_AD = 0.25;
            const BONUS_3_ADS = 0.75;
            const MIN_WITHDRAW_POINTS = 50;
            const HOURLY_BONUS_MIN = 0.01;
            const HOURLY_BONUS_MAX = 5;
            const WAIT_TIME = 15; // seconds
            const ANTI_FRAUD_MESSAGE = "Fake or duplicate referrals may result in reward removal.";
            const SUPPORT_LINK = "https://t.me/dailyearningsupport";

            // DOM Elements
            const userPhotoElem = document.getElementById('user-photo');
            const userNameElem = document.getElementById('user-name');
            const userPointsElem = document.getElementById('user-points');
            const dateDisplay = document.getElementById('date-display');
            const timeDisplay = document.getElementById('time-display');
            const watchAdBtn = document.getElementById('watch-ad-btn');
            const productReviewBtn = document.getElementById('product-review-btn');
            const watchThreeBtn = document.getElementById('watch-three-btn');
            const withdrawForm = document.getElementById('withdraw-form');
            const withdrawSubmitBtn = document.getElementById('withdraw-submit-btn');
            const referralLinkElem = document.getElementById('referral-link');
            const copyRef = document.getElementById('copy-ref');
            const qrBtn = document.getElementById('qr-btn');
            const qrCode = document.getElementById('qr-code');
            const loadingModal = document.getElementById('loading-modal');
            const timerModal = document.getElementById('timer-modal');
            const adTimer = document.getElementById('ad-timer');
            const successModal = document.getElementById('success-modal');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const streakFill = document.getElementById('streak-fill');
            const timerElem = document.getElementById('timer');
            const claimBonusBtn = document.getElementById('claim-bonus-btn');
            const historyList = document.getElementById('history-list');
            const statusList = document.getElementById('status-list');
            const historyListWithdraw = document.getElementById('history-list-withdraw');
            const totalEarnings = document.getElementById('total-earnings');
            const totalReferrals = document.getElementById('total-referrals');
            const tasksCompleted = document.getElementById('tasks-completed');
            const helpButton = document.querySelector('.help-support button');

            // State Management
            let userState = {
                points: 0,
                dailyAdWatchCount: 0,
                lastAdWatchDate: null,
                referrals: [],
                userId: null,
                streak: 0,
                lastLoginDate: null,
                consecutiveAds: 0,
                tasksCompleted: 0,
                totalEarnings: 0,
                withdrawalHistory: [],
                coinHistory: [],
                lastBonusTime: null,
                membership: 'free' // free, verified, premium, diamond
            };

            const saveState = () => {
                if (userState.userId) {
                    localStorage.setItem(`userState_${userState.userId}`, JSON.stringify(userState));
                }
            };

            const loadState = (userId) => {
                const savedState = localStorage.getItem(`userState_${userId}`);
                if (savedState) {
                    userState = JSON.parse(savedState);
                }
            };

            const addCoinHistory = (type, amount) => {
                userState.coinHistory.push({ type, amount, date: new Date().toLocaleString() });
                if (type === 'earn') userState.totalEarnings += amount;
                saveState();
                updateUI();
            };

            const initApp = () => {
                tg.ready();
                tg.expand();
                document.body.className = `${tg.colorScheme}-theme`;

                const user = tg.initDataUnsafe.user;
                if (!user || !user.id) {
                    tg.showAlert("Could not verify user. Please open this app through Telegram.", () => tg.close());
                    return;
                }

                userState.userId = user.id;
                loadState(user.id);

                handleStreak();
                updateDateTime();
                setInterval(updateDateTime, 1000);
                startHourlyTimer();

                updateUI();
                setupNavigation();
                setupEventListeners();
                saveState();
            };

            const handleStreak = () => {
                const today = new Date().toISOString().slice(0, 10);
                if (userState.lastLoginDate !== today) {
                    if (userState.lastLoginDate === new Date(Date.now() - 86400000).toISOString().slice(0, 10)) {
                        userState.streak++;
                    } else {
                        userState.streak = 1;
                    }
                    userState.lastLoginDate = today;
                    addCoinHistory('earn', 1); // Daily check-in bonus
                }
            };

            const updateDateTime = () => {
                const now = new Date();
                dateDisplay.textContent = now.toLocaleDateString('bn-BD');
                timeDisplay.textContent = now.toLocaleTimeString('bn-BD');
            };

            const startHourlyTimer = () => {
                const now = Date.now();
                if (!userState.lastBonusTime || now - userState.lastBonusTime >= 3600000) {
                    claimBonusBtn.disabled = false;
                } else {
                    const remaining = 3600000 - (now - userState.lastBonusTime);
                    updateTimer(remaining / 1000);
                    setTimeout(startHourlyTimer, 1000);
                }
            };

            const updateTimer = (seconds) => {
                const min = Math.floor(seconds / 60);
                const sec = Math.floor(seconds % 60);
                timerElem.textContent = `${min}:${sec < 10 ? '0' : ''}${sec}`;
                if (seconds > 0) {
                    setTimeout(() => updateTimer(seconds - 1), 1000);
                } else {
                    claimBonusBtn.disabled = false;
                }
            };

            const claimHourlyBonus = () => {
                const bonus = Math.random() * (HOURLY_BONUS_MAX - HOURLY_BONUS_MIN) + HOURLY_BONUS_MIN;
                userState.points += bonus;
                addCoinHistory('earn', bonus);
                userState.lastBonusTime = Date.now();
                claimBonusBtn.disabled = true;
                startHourlyTimer();
            };

            const showWaitTimer = (duration, callback) => {
                timerModal.style.display = 'flex';
                adTimer.textContent = duration;
                const interval = setInterval(() => {
                    duration--;
                    adTimer.textContent = duration;
                    if (duration <= 0) {
                        clearInterval(interval);
                        timerModal.style.display = 'none';
                        callback();
                    }
                }, 1000);
            };

            const handleAdWatch = (bonus = POINTS_PER_AD, isThree = false) => {
                loadingModal.style.display = 'flex';
                show_9712189().then(() => {
                    loadingModal.style.display = 'none';
                    showWaitTimer(WAIT_TIME, () => {
                        userState.points += bonus;
                        userState.dailyAdWatchCount++;
                        userState.tasksCompleted++;
                        userState.consecutiveAds = isThree ? userState.consecutiveAds + 1 : 1;
                        if (userState.consecutiveAds === 3) {
                            userState.points += BONUS_3_ADS;
                            userState.consecutiveAds = 0;
                            addCoinHistory('earn', BONUS_3_ADS);
                        }
                        addCoinHistory('earn', bonus);
                        tg.HapticFeedback.notificationOccurred('success');
                        tg.showAlert(`Earned ${bonus} TK!`);
                        saveState();
                        updateUI();
                    });
                }).catch(() => {
                    tg.showAlert("Ad failed.");
                    loadingModal.style.display = 'none';
                });
            };

            const handleThreeAds = () => {
                handleAdWatch(POINTS_PER_AD, true);
                setTimeout(() => handleAdWatch(POINTS_PER_AD, true), WAIT_TIME * 1000 + 1000);
                setTimeout(() => handleAdWatch(POINTS_PER_AD, true), 2 * (WAIT_TIME * 1000 + 1000));
            };

            const updateUI = () => {
                const user = tg.initDataUnsafe.user;
                if (user) {
                    userPhotoElem.src = user.photo_url || 'https://i.imgur.com/placeholder.png';
                    userNameElem.innerHTML = `${user.first_name || ''} ${user.last_name || ''} <i class="fas fa-check-circle verified-icon"></i>`;
                }

                userPointsElem.textContent = userState.points.toFixed(2);
                referralLinkElem.value = `https://t.me/${BOT_USERNAME}?start=ref_${userState.userId}`;
                streakFill.style.width = `${(userState.streak / 7) * 100}%`; // Assume weekly streak max 7

                // Update history
                historyList.innerHTML = userState.coinHistory.map(item => `<div class="history-item glass-card">${item.date}: ${item.type} ${item.amount} TK</div>`).join('');
                statusList.innerHTML = userState.withdrawalHistory.map(item => `<div class="status-item glass-card ${item.status}">${item.amount} TK — ${item.status} (${item.date})</div>`).join('');
                historyListWithdraw.innerHTML = statusList.innerHTML;

                totalEarnings.textContent = `${userState.totalEarnings} TK`;
                totalReferrals.textContent = userState.referrals.length;
                tasksCompleted.textContent = userState.tasksCompleted;

                // Membership badge
                const badge = document.querySelector('.membership-badge');
                badge.className = `membership-badge ${userState.membership}`;
                badge.textContent = userState.membership.charAt(0).toUpperCase() + userState.membership.slice(1) + ' Member';

                document.body.classList.toggle('dark-theme', darkModeToggle.checked);
            };

            const setupEventListeners = () => {
                watchAdBtn.addEventListener('click', () => handleAdWatch(POINTS_PER_AD));
                productReviewBtn.addEventListener('click', () => handleAdWatch(POINTS_PER_AD));
                watchThreeBtn.addEventListener('click', handleThreeAds);
                document.querySelectorAll('.watch-ad-task').forEach(btn => btn.addEventListener('click', () => handleAdWatch(POINTS_PER_AD)));
                document.querySelectorAll('.product-review-task').forEach(btn => btn.addEventListener('click', () => handleAdWatch(POINTS_PER_AD)));
                document.querySelectorAll('.watch-three-task').forEach(btn => btn.addEventListener('click', handleThreeAds));
                withdrawForm.addEventListener('submit', handleWithdraw);
                copyRef.addEventListener('click', copyReferralLink);
                qrBtn.addEventListener('click', () => {
                    qrCode.style.display = 'block';
                    QRCode.toCanvas(qrCode, referralLinkElem.value);
                });
                darkModeToggle.addEventListener('change', updateUI);
                claimBonusBtn.addEventListener('click', claimHourlyBonus);
                helpButton.addEventListener('click', () => tg.openTelegramLink(SUPPORT_LINK));
                // Placeholder for other task buttons
                document.querySelectorAll('.daily-checkin').forEach(btn => btn.addEventListener('click', () => addCoinHistory('earn', 1)));
                document.querySelectorAll('.share-app').forEach(btn => btn.addEventListener('click', () => addCoinHistory('earn', 2)));
                document.querySelectorAll('.rate-app').forEach(btn => btn.addEventListener('click', () => addCoinHistory('earn', 5)));
                document.querySelectorAll('.complete-survey').forEach(btn => btn.addEventListener('click', () => addCoinHistory('earn', 3)));
                document.querySelectorAll('.play-game').forEach(btn => btn.addEventListener('click', () => addCoinHistory('earn', 4)));
                document.querySelectorAll('.read-article').forEach(btn => btn.addEventListener('click', () => addCoinHistory('earn', 2)));
                document.querySelectorAll('.watch-tutorial').forEach(btn => btn.addEventListener('click', () => addCoinHistory('earn', 1)));
            };

            const handleWithdraw = async (e) => {
                e.preventDefault();
                const method = document.getElementById('withdraw-method').value;
                const accountNumber = document.getElementById('account-number').value;
                const amount = parseFloat(document.getElementById('amount').value);

                if (isNaN(amount) || amount <= 0 || amount < MIN_WITHDRAW_POINTS || amount > userState.points) {
                    tg.showAlert("Invalid amount.");
                    return;
                }

                withdrawSubmitBtn.classList.add('loading');
                withdrawSubmitBtn.disabled = true;

                userState.points -= amount;
                addCoinHistory('spend', amount);
                const withdrawItem = { amount, status: 'Processing', date: new Date().toLocaleDateString(), method };
                userState.withdrawalHistory.push(withdrawItem);
                saveState();
                updateUI();

                const user = tg.initDataUnsafe.user;
                const message = `<b>New Withdraw Request!</b>\nUser: ${user.first_name} (@${user.username})\nID: ${user.id}\nMethod: ${method}\nAccount: ${accountNumber}\nAmount: ${amount} TK`;

                const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chat_id: ADMIN_CHAT_ID, text: message, parse_mode: 'HTML' })
                    });
                    if (response.ok) {
                        successModal.style.display = 'flex';
                        setTimeout(() => successModal.style.display = 'none', 2000);
                        tg.showAlert("Request submitted!");
                        withdrawForm.reset();
                    }
                } catch {
                    tg.showAlert("Failed. Points returned.");
                    userState.points += amount;
                } finally {
                    withdrawSubmitBtn.classList.remove('loading');
                    withdrawSubmitBtn.disabled = false;
                    updateUI();
                }
            };

            const copyReferralLink = () => {
                navigator.clipboard.writeText(referralLinkElem.value).then(() => tg.showAlert("Copied!"));
            };

            const setupNavigation = () => {
                const navButtons = document.querySelectorAll('.nav-btn');
                const pages = document.querySelectorAll('.page');
                navButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const pageId = button.dataset.page;
                        pages.forEach(page => page.classList.remove('active'));
                        document.getElementById(pageId).classList.add('active');
                        navButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                    });
                });
            };

            initApp();
        });
    </script>
</body>
</html>
